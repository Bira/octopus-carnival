<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Computering Interval: Fast Firefox Video the Hard Way | Octopus Carnival</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Computering Interval: Fast Firefox Video the Hard Way" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The Firefox logo." />
<meta property="og:description" content="The Firefox logo." />
<link rel="canonical" href="https://bira.github.io/octopus-carnival/2023/11/21/graphics-driver-nerdery.html" />
<meta property="og:url" content="https://bira.github.io/octopus-carnival/2023/11/21/graphics-driver-nerdery.html" />
<meta property="og:site_name" content="Octopus Carnival" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-11-21T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Computering Interval: Fast Firefox Video the Hard Way" />
<meta name="twitter:site" content="@mestre_bira" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-11-21T00:00:00+00:00","datePublished":"2023-11-21T00:00:00+00:00","description":"The Firefox logo.","headline":"Computering Interval: Fast Firefox Video the Hard Way","mainEntityOfPage":{"@type":"WebPage","@id":"https://bira.github.io/octopus-carnival/2023/11/21/graphics-driver-nerdery.html"},"url":"https://bira.github.io/octopus-carnival/2023/11/21/graphics-driver-nerdery.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/octopus-carnival/css/main.css"><link type="application/atom+xml" rel="alternate" href="https://bira.github.io/octopus-carnival/feed.xml" title="Octopus Carnival" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" rel="author" href="/octopus-carnival/">Octopus Carnival</a>

    <nav class="site-nav">
      <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>

      <div class="trigger">
        <a class="page-link" href="/octopus-carnival/projects/">Projects</a>
        <a class="page-link" href="/octopus-carnival/about/">About</a>
      </div>
    </nav>

  </div>

</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Computering Interval: Fast Firefox Video the Hard Way</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2023-11-21T00:00:00+00:00" itemprop="datePublished">
        Nov 21, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <figure class="center">
   <img src="https://bira.github.io/octopus-carnival/assets/firefox-logo.png"/>
   <figcaption>
   The Firefox logo.
   </figcaption>
</figure>

<p>I usually write about roleplaying games around here, but I just spend quite a
bit of time chasing down a weird computer issue and I want to write about it
somewhere to record the steps I took.</p>

<p>If you’re not a big Linux nerd, feel free to skip this. If you <em>are</em> and have
issues with how I did things, feel free to skip this as well. If you want to
read this anyway, I try to explain some of the basic concepts behind this
quixotic adventure in footnotes.</p>

<h2 id="what-happened">What Happened</h2>

<p>I run Ubuntu on my home desktop, and I currently updated to the latest release
version, 23.10. It was a small upgrade, as I was already running
23.04. Everything worked fine.</p>

<p>Then I saw <a href="https://youtu.be/Yi5LFtNTGrs?si=CaEw_fKJMYLh7191&amp;t=256">a video</a> with some news about version 545 of the nVidia drivers
being released. I was using 535, which again worked fine, but I heard that
545.29.02 fixed a lot of bugs and added some improvements I had been waiting
for.</p>

<p>These weren’t part of the official Ubuntu distribution yet, so I added the
<a href="https://launchpad.net/~graphics-drivers/+archive/ubuntu/ppa">Graphics Drivers PPA</a> to my system, which did have them:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>add-apt-repository ppa:graphics-drivers/ppa

<span class="nb">sudo </span>apt update
</code></pre></div></div>

<p>I installed the new drivers, tweaked my Firefox config to use Wayland<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>, and
tested the new setup with a Youtube video. I saw that the videos there remained
weirdly laggy, so I went back to X11 but decided to keep the new driver around
for its other improvements.</p>

<p>It worked quite well for games and everyday usage… but I noticed that my
Youtube videos were still weirdly laggy on X11, and that my computer was
getting quite a bit hotter while playing them than it used to. The “Stats for
Nerds” menu told me they were dropping more or less 50% of their frames, which
is <em>bad</em>.</p>

<p>A little investigation showed me that the Firefox browser did not in fact play
very well with that new graphics driver, at least not in the Snap version that
was installed by default on Ubuntu Linux<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>. It didn’t really “see” my video
card and so was sending all of its graphical work to the processor instead. It
already did this with videos, but now it was doing this for everything.</p>

<p>The easiest solution to this problem <em>by far</em>, would have been to go back to
version 535 of my graphics driver, the one I had before that worked just fine. I
could wait for this stuff to get fixed upstream without worrying about it.</p>

<p>This is not what I did.</p>

<h2 id="what-i-did-instead">What I Did Instead</h2>

<p>I went spelunking into the depths of DuckDuckGo, looking for a way to enable
hardware-based graphical acceleration on Firefox. That would make it use my
video card both for displaying web pages and for playing video.</p>

<p>Firefox has been able to do this for a while now, but the option was only
enabled by default on Windows or in Linux computers with Intel graphic cards. I
have an Nvidia card with proprietary drivers, so I’m out of luck.</p>

<p>Firefox uses something called VA-API to talk to the video card when hardware
acceleration is on. On machines like mine the capability is forcibly disabled,
because those drivers don’t support VA-API. It’s possible to bridge the gap, but
the process for that seems to be a bit experimental still. Most people do not
have the time or inclination to worry about that, and are happier for it.</p>

<p>After some trial and error, this was the sequence of events that led me to
success.</p>

<h3 id="step-one-bridging-the-gap">Step One: Bridging the Gap</h3>

<p>A developer with the horrible user name of El Farto has <a href="https://github.com/elFarto/nvidia-vaapi-driver">a Github repository</a>
that contains the code for <code class="language-plaintext highlighter-rouge">nvidia-vaapi-driver</code> a little wrapper program that
translates VA-API calls into something the Nvidia drivers understand and
vice-versa. The package is actually part of my default Linux distribution, but
since I’m on the 545 drivers I needed a more recent version straight from the
source. That’s v0.0.11, which has support for those drivers.</p>

<p>Following the excellent documentation in that repository, I did the following:</p>

<ul>
  <li>
    <p>Compiled <code class="language-plaintext highlighter-rouge">nvidia-vaapi-driver</code> v0.0.11 from source and installed it.</p>
  </li>
  <li>
    <p>Edited <code class="language-plaintext highlighter-rouge">/etc/default/grub</code> and changed the <code class="language-plaintext highlighter-rouge">GRUB_CMDLINE_LINUX_DEFAULT</code>
variable to the follwing:</p>
  </li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s2">"quiet splash nvidia_drm.modeset=1"</span>
</code></pre></div></div>

<ul>
  <li>Edited <code class="language-plaintext highlighter-rouge">/etc/environment</code> and added the following environment variables to it:</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">LIBVA_DRIVER_NAME</span><span class="o">=</span>nvidia
<span class="nv">MOZ_DISABLE_RDD_SANDBOX</span><span class="o">=</span>1
<span class="nv">NVD_BACKEND</span><span class="o">=</span>direct
</code></pre></div></div>

<p>Then I rebooted my computer, and found out the Snap version of Firefox didn’t
detect my video card. Whoops!</p>

<p>The next step was therefore to get rid of Snap Firefox in favor of the
traditionally-packaged version. Give up? Never!</p>

<h3 id="step-two-fox-replacement-surgery">Step Two: Fox Replacement Surgery</h3>

<p>First, I added the repository with the “traditional” packages for Firefox:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>add-apt-repository ppa:mozillateam/ppa
<span class="nb">sudo </span>apt update
</code></pre></div></div>

<p>Then I added a file named <code class="language-plaintext highlighter-rouge">/etc/apt/preferences.d/mozilla-firefox</code> with the
following contents:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Package: firefox<span class="k">*</span>
Pin: release <span class="nv">o</span><span class="o">=</span>LP-PPA-mozillateam
Pin-Priority: 1001

</code></pre></div></div>

<p>This ensures that the PPA’s version is chosen over the Snap. The next step is to
remove the Snap and install the traditional package:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>snap remove firefox

<span class="nb">sudo </span>apt remove firefox

<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-t</span> <span class="s1">'o=LP-PPA-mozillateam'</span> firefox
</code></pre></div></div>

<p>Since my user profile is in my home directory this preserved all of my bookmarks
and add-ons. Whew! And Firefox could now see my graphics card.</p>

<h3 id="step-three-chant-the-deep-magic">Step Three: Chant the Deep Magic</h3>

<p>The final step was to change some advanced browser configurations in the dreaded
<code class="language-plaintext highlighter-rouge">about:config</code> screen.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">gfx.webrender.all</code> to <code class="language-plaintext highlighter-rouge">true</code> -&gt; This lets it use the graphics card to
render web pages.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">media.ffmpeg.vaapi.enabled</code> to <code class="language-plaintext highlighter-rouge">true</code> -&gt; for video acceleration</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">media.rdd-ffvpx.enabled</code> to <code class="language-plaintext highlighter-rouge">false</code> -&gt; This disables the built-in-software
codecs in Firefox.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">gfx.x11-egl.force-enabled</code> and <code class="language-plaintext highlighter-rouge">widget.dmabuf.force-enabled</code> to <code class="language-plaintext highlighter-rouge">true</code> -&gt;
These are needed to get past the “hard blocks” imposed on the browser due to
its default configuration.</p>
  </li>
</ul>

<p>These take effect after I restart the browser. Finally, hardware acceleration
works! My computer heads up considerably less than it did, my videos in Firefox
have a buttery-smooth framerate, and I only had to battle a maximum of two Elder
Things to acquire the knowledge of how to do so.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>A compositor, the part responsible for drawing windows and whatnot on the
screen of a Linux computer. Wayland is the new hotness in that area, X11 is
the older thing it’s replacing. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>Snaps are a form of packaged program that’s a bit more isolated from your
base system than usual. They’re less dependent on the specific traits of
your base system. Snaps are a bit more tricky for developers to configure
right, but they only have to do that once. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <div class="page-nav"><a class="prev" href="/octopus-carnival/2023/11/16/hackaton-nco.html">&laquo; The Great Tabletop Hackathon: Neon City Overdrive</a><a class="next" href="/octopus-carnival/2023/11/23/neverwinter-kolthunral.html">Neverwinter Kolthunral &raquo;</a></div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://bira.github.io/octopus-carnival/2023/11/21/graphics-driver-nerdery.html';
      this.page.identifier = 'https://bira.github.io/octopus-carnival/2023/11/21/graphics-driver-nerdery.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://octopus-carnival.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/octopus-carnival/2023/11/21/graphics-driver-nerdery.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/octopus-carnival/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Octopus Carnival</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Octopus Carnival</li><li><a class="u-email" href="mailto:u.alberton@gmail.com">u.alberton@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/Bira"><svg class="svg-icon"><use xlink:href="/octopus-carnival/assets/minima-social-icons.svg#github"></use></svg> <span class="username">Bira</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A repository of my English language RPG-related writings. Mostly GURPS with a smattering of other systems.
</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
